\section{Mikrocontroller}
\label{sec:mikrocontroller}
\subsection{Krav til mikrocontrolleren}
\todo[inline, author=Michael]{Husk at TEST sektionen skal se om vi opfylder disse krav. Hvis ikke vi tester tingene skal de slettes fra dette afsnit!!!}
Mikrocontrolleren har følgende opgaver: 
%\todo[inline, author=Michael]{YOU CANT TOUCH THIS - lad mig lige skrive færdig!}
%\todo[inline, author=Michael]{Denne sektion mangler generelt at blive forkortet. }
%\todo[inline, author=Michael]{Anders, kan vi ændre layouttet så listerne ikke tager så meget plads? }


\begin{itemize}
\itemsep1pt
	\item Afvikling af regulatorerne.
	\item Kommunikation med FPGA vha. SPI.
	\item Modtage kommandoer fra PC'en via UART.
	\item Sende relevant data til brugeren via UART.
\end{itemize}

Regulatorerne skal afvikles i realtid, da det ellers er vanskelligt at modellere forsinkelsen matematisk.


SPI\footnote{Serial Peripheral Interface, også kaldet SSI} bruges til at overføre PTS's position fra FPGA til mikrocontroller. Desuden overføres beregnet duty-cycle fra mikrocontroller til FPGA. Kommunikationen skal være tilpas hurtig, så regulatorerne ikke beregner på forældet data. Forsinkelsen for overførsel af data må ikke overstige 5\% af sampletiden. 
\todo[inline, author=Michael]{Ved Ts = 1/600 er det $8,33 * 10^5$. Indsæt de endelige tal når matematikgruppen når videre med tallene. }

Systemet skal kunne modtage brugerinput gennem et terminalprogram. Brugerinterfacet er ikke tidskritisk. Der skal være mulighed for at udlæse systemparametre:

\begin{itemize}
\itemsep1pt
	\item PTS' position. 
	\item Ønsket position. 
	\item Afvigelse fra ønsket position. 
\end{itemize}

Desuden skal systemet gemme disse informationer i en log-fil, som kan udlæses efter systemet er færdig med at tracke målet. 

Systemet skal kunne reagere på følgende bruger inputs:


\begin{itemize}
\itemsep1pt
	\item Start tracking
	\item Stop tracking
	\item Reset systemet
	\item Gå til koordinat (x,y,z)
	\item Set PWM
	\item Læs log
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Beskrivelse af valgt(?) mikrocontroller.}
Den udleverede mikrocontroller er en 32 bit Stellaris LM3S6965, baseret på en ARM Cortex M3 kerne. Den opererer ved 50 [mHz] og bruger Thump 2 instruktionssættet. Den indeholder 256 [KB] flash hukommelse samt 64 [KB] SRAM. 
\citep{lm3s6965}

SPI er indbygget som et hardwaremodul, med seperate FIFO buffere til afsendelse og modtagelse. Hardwaren sender data fra den ene den buffer og lægger modtaget data i den anden. Derfor er det ikke nødvendigt for programmøren at holde styr på timingen. Størrelsen af hvert dataframe kan være 4 - 16 bits. 

UART er også implementeret som et hardwaremodul. Modulet indeholder seperate FIFO buffere til afsendelse og modtagelse af data, hver med plads til 16 datawords (max 8 bit). 

Controlleren indeholder også et væld af hardwaremoduler til andre funktioner, men disse er ikke relevante for projektet.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Valg af skedulering}
\todo[inline, author=Michael]{Jeg skal lige have skimmet OSC bogen for ideer til denne sektion}
Der er undersøgt 4 forskellige mulige skeduleringsalgoritmer: 

\begin{itemize}
\itemsep1pt
	\item CoOS\footnote{coocox.com/CoOS.htm}
	\item freeRTOS\footnote{freertos.org}
	\item Run-To-Complete-Scheduler\footnote{Introduceret i EMP-kurset}
	\item Super-loop
\end{itemize}

Til valget er der lagt vægt på følgende parametre: 

\begin{itemize}
\itemsep1pt
	\item Opfylder kravene til realtidsafvikling af regulatorerne. 
	\item Muligheden for at (gen)bruge elementer fra EMP-kurset.
\end{itemize}

\begin{table}[h!]
\begin{tabular}{|l|l|l|l|l|}
\hline 
 & coOS & freeRTOS & RTCS & Super loop \\ 
\hline 
Skedulering & Preemptive priority  & Preemptive priority  & Non-preemptive & Non-preemptive  \\ 
			& /round robin		&	/round robin & &	\\
\hline 
Queues & Ja & Ja & Nej & Nej \\ 
\hline 
Semaphore & ?  & Counting + binære & Binære  & Nej  \\ 
\hline 
Introduceret & Nej & Ja & Ja & Ja \\ 
i EMP kurset &   &   &   &   \\
\hline 
\end{tabular} 
\caption{Specifikationer for de undersøgte systemer}
\label{tb:os_comparison}
\end{table}
\todo[inline, author=Michael]{Ikke færdig}
\subsection{Implementering}
%disp: 
% task diagram
% beskrivelse af tasks
% implementering af enkelt task (CONTROL TASK). 
%   - hvordan sikres at denne kører realtid.
% 
% beskrivelse af interfacet
% 

Valget af freeRTOS som operativsystem gjorde det muligt at opdele programmet i seperate tasks. Taskdiagrammet er vist på figur \ref{fig:task_diagram}. 

\todo[inline, author=Michael]{I figuren burde vi bruge rette linjer istedet for de afrundede. Desuden skal kommunikationen med SPI indtegnes på en eller anden måde. Irrelevante semaphorer over de fleste køer skal også fjernes. }
% TASK DIAGRAM
\begin{figure}[!h]
\centering
\begin{tikzpicture}[node distance = 3.2cm]
	\include*{./graphics/uc_task_diagram}
\end{tikzpicture}
\caption[Task diagram]{Taskdiagrammet viser programmets opdeling i tasks.}
\label{fig:task_diagram}
\end{figure}

\subsubsection{Beskrivelse af de enkelte tasks}
\begin{description}
	\item[Uart send] Tager indholdet fra uart\_ out\_ buffer og ligger dem ind i UART-modulets hardware FIFO buffer. Dette er nødvendigt fordi hw. bufferen kun indeholder 16 pladser\footnote{Jævnfør s. 430 i LM3S6965}.
	\item[Uart receive] Læser UART-modulets hardware buffer og lægger de modtagne data over i uart\_ in \_ buffer. 
	\item[Interface] Tolker på brugerinputs og sender relevante kommandoer til Control- og read\_ pos-tasken.
	\item[read pos] Opdaterer target\_ pos med målets nuværende koordinater 60 gange i sekundet. I vores projekt læser den blot værdierne fra et array, men den kan sagtens udskiftes med en anden task der f.eks. tolker på input fra et kamera.
	\item[Control] Afvikler regulatorerne. Se mere indgående beskrivelse i sektion \ref{sec:control_task}. Denne task afvikles i realtid, med en frekvens på 600 Hz. 
	\item[log updater] Denne task opdaterer logfilen  med data fra "status" køen.
\end{description}


%Semaphorer på target_pos. 
%Ingen semaphorer på køer, undtagen uart out buffer


\subsubsection{Control task}
\label{sec:control_task}


\subsection{Test} 
% Test af SPI overførsel
% Test af realtidsafvikling af reguleringssløjferne, 
% lever vi op til kravene?
% 





\subsection{Delkonklusion}
