\section{FPGA}
\label{sec:FPGA}
FPGA'en er leddet mellem mikrokontrolleren og motorene på PTS.
Følgende opgaver til FPGA'en er fastsat af projektbeskrivelsen:

\begin{itemize}
\itemsep1pt
	\item Kommunikation med mikrocontrolleren vha. SPI.
	\item Producering af PWM signal til motorerne på PTS.
	\item Optælling af motorernes rotationer vha. encoders på PTS.
\end{itemize}

FPGA'en er i projeket et BASYS board\footnote{Datablad \citep{basys2}}, der programmeres ved brug af VHDL\footnote{VHSIC Hardware Description Language}.

\subsection{Foretagede valg i opbygning af FPGA funktionalitet}
Eftersom de fleste krav til FPGAeFPGA'enn er givet af projektbeskrivelsen, er der ikke 
lavet noget større analysearbejde af FPGA'ens funktionalitet. Undervejs i 
udviklingen af funktionaliteten er der dog taget nogle valg.

\textbf{Generiske komponenter}\\
For at lave et system med lav kobling er det forsøgt at lave 
generiske komponenter til de funktionaliteter, der er af generel art. 
Til at varetage den resterende funktionalitet, er der skrevet applikationsspecifikke 
komponenter.
Dette sikrer, at koden er let at udbygge og genbruge.

\textbf{PWM}\\
Der skal fra FPGA'en genereres PWM signaler til at styre motorerne på PTS.
Det ønskes at have en PWM frekvens, der ikke ligger i det hørbare område, hvilket ca. går op til 20 [kHz]\footnote{\citep{Hearingrange}}. 
Det ønskes at have en opløsning på PWM, der er mindst ligeså høj, som 
opløsningen på PTS rotation, for ikke at forringe opløsningen på reguleringen. 
Det er derfor valgt at repræsentere PWM dutycycle ved 11 bit. 
Ved 11 bits opløsning på PWM og brug af BASYS boardets interne clock på 50 [MHz] bliver PWM frekvensen passende høj:

\begin{equation}
  \frac{50 \text{ [MHz]}}{2^{11}} = 24.41 \text{ [kHz]}
\end{equation}

\textbf{Kalibrering af motorposition}\\
PTS skal kunne tændes i en tilfældig position og derefter kalibreres.
Kalibreringen af motorpositionen kan laves ved at sørge for at PTS drejer forbi 
de to hall sensorer, der er placeret på systemet. Dette vil give et signal, da 
der på PTS er placeret en magnet på hver af rammerne.
%Det blev besluttet at placere ansvaret for at dreje rammerne hen til hall 
%sensorerne hos mikrocontrolleren. Det blev besluttet, da det giver mulighed for 
%en simplere protokol mellem FPGA og mikrokontroller. Det sikrer samtidigt at mikrocontrolleren 
%altid har kontrol over hvordan PTS bevæger sig.
Funktionaliteten der skal være på FPGA'en er at opfange outputtet fra 
hall sensorerne og nulstille den tilhørende position.
Dog viste det sig, at hall sensorernes output ikke kun er højt på ét encodertick, 
men derimod adskillige. Det er nødvendigt at FPGA'en tager højde for 
dette.

\subsection{Opbygningen på FPGA}
På figur \ref{fig:FPGA_blok} ses et simplificeret diagram over komponenterne på FPGA'en. 
De grønne bokse angiver komponenter på FPGA'en, mens de grå cirkler angiver hvad, der ikke ligger på 
FPGA'ens chip. Pilene imellem FPGA'ens komponenter angiver retningen på 
datastrømme. Diagrammet er simplificeret ved at vise to ens komponenter som én. 
F.eks. er der ikke én tic counter komponent på FPGA'en, men derimod to.
Herunder følger en forklaring på hvordan de tre krav til FPGA'en er opnået. For 
yderligere forklaring af komponenterne henvises til appendix 
\ref{sec:fpgaappendix}.



\begin{figure}[!th]
\centering
\begin{tikzpicture}[node distance = 5 cm,scale=1]
\include*{./graphics/FPGA_blok}
\end{tikzpicture}
\caption[Diagram over FPGA komponenter]{Simplificeret diagram over komponenterne på FPGA'en}
\label{fig:FPGA_blok}
\end{figure}

%\todo[author=Åse,inline]{Teksten over figuren kan uddybes, med at beskrive de vigtigeste komponenter. Mens kan teksten nedenunder komme i appendix.}
%\subsection{SPI}
%På FPGA'en er SPI'en to shift registre. SPI'en konvertere det serielle signal fra MOSI til at parallel signal. Det signal sendes videre til Input decoder, som deler det op i komposanter. Fra Output decoder får SPI signalet, den skal sende til mikrocontrolleren.

\subsection{Kommunikation med mikrocontrolleren vha. SPI.}
På FPGA'en er implementeret en SPI slave der modtager data fra 
mikrocontrolleren. Data føres, i komponenten SPI, fra MISO ind i FPGA'en og fra FPGA'en ud på 
MOSI. Til mikrocontrolleren sendes skiftevis motorposition fra pan og tilt.

\subsection{Producering af PWM signal til motorerne på PTS.}
I PWM komponenten produceres PWM på baggrund af dutycycle værdier modtaget vha. SPI. 
PWM bliver produceret ved at tælle en tæller op fra 0 til 2047 med 50 MHz.
PWM udgangen sættes høj indtil tælleren når dutycycle værdien og sættes lav 
ellers. Hermed er der produceret et PWM med en frekvens på ca. 24 kHz.

\subsection{Optælling af motorernes rotationer vha. encoders på PTS.}
Da encoderne på PTS er quadrature encodere er det muligt at bestemme både retning og tælle rotationer på motoren. 
Dette sker i komponenten tic counter der afhængigt af inputtet fra encoderne tæller positionen op eller 
ned.
Der tælles ned fra 0 til 1079 og op  fra 1079 til 0.
Resetsignal modtages fra komponenten tic reset, når pan eller tilts magnet bevæger 
sig over hallsensorerne.

\subsection{Delkonklusion}
FPGA'en fungerer som simpel slave i en SPI overførsel med mikrocontrollere, holder styr på pan og tilts motorpositon samt producerer PWM 
med en frekvens på ca. 24 [kHz] og en opløsning på 2048.